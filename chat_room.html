<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room - VidyaGyan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        
        .chat-container {
            min-height: calc(100vh - 80px);
        }
        
        /* Custom CSS for the Chatbot Button */
        #chatbot-button {
            position: fixed;
            bottom: 50px;
            right: 50px;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid #6366f1;
        }

        #chatbot-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        #chatbot-button img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-teal-50">
    <!-- Header Navigation Bar -->
    <header class="relative z-20 w-full p-2 flex justify-between items-center text-white bg-gray-900">
        <div class="flex items-center space-x-2">
            <!-- Mobile Menu Button -->
            <button id="menu-btn" class="text-white focus:outline-none md:hidden">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
            <!-- Logo and Site Name -->
            <div class="flex items-center space-x-2">
                <a href="index.html">
                    <img src="./assets/mainlogo.png" alt="VidyaGyan Logo" class="w-10 h-10">
                </a>
                <span class="text-3xl font-bold text-white">VidyaGyan</span>
            </div>
        </div>
        <!-- Desktop Navigation Links -->
        <nav class="hidden md:flex items-center space-x-4 text-base">
            <a href="career_paths.html"
                class="text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">Career Paths</a>
            <a href="roadmaps/roadmap.html"
                class="text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">Roadmaps</a>
            <a href="colleges.html"
                class="text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">Colleges</a>
            <a href="exams.html"
                class="text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">Exams</a>
            <a href="resources.html"
                class="text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">Resources</a>
            <a href="study_groups.html"
                class="text-white px-3 py-2 rounded-lg bg-gray-800 transition-colors duration-200">Study Groups</a>
            <a href="scholarship.html"
                class="text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">Scholarships</a>
        </nav>
        <!-- Action Buttons (Home, Profile, and For You) -->
        <div class="hidden md:flex items-center space-x-4">
            <a href="home.html"
                class="flex items-center space-x-2 text-white hover:text-gray-200 px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">
                <!-- Home Icon -->
                <img src="assets/home.png" alt="Home" class="w-8 h-8">
            </a>
            <a href="profile.html"
                class="flex items-center space-x-2 text-white hover:text-gray-200 px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200">
                <!-- Profile Icon -->
                <img src="assets/profile.jpg" alt="Profile" class="w-8 h-8">
            </a>
            <a href="foryou.html"
                class="text-sm px-6 py-3 rounded-full border-2 border-blue-500 text-blue-500 hover:text-white hover:bg-blue-500 transition-colors duration-300">For You</a>
        </div>
    </header>

    <!-- Chatbot Button -->
    <a href="chat.html" id="chatbot-button" title="Chat with us!">
        <img src="./assets/images/chat.jpeg" alt="Chatbot" />
    </a>

    <!-- Main Content -->
    <div class="chat-container flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-5xl">
            <!-- Simple Header -->
            <div class="text-center mb-8">
                <h1 id="room-title" class="text-3xl font-bold text-gray-800 mb-2">Loading...</h1>
                <p id="room-description" class="text-gray-600">Please wait while we load the chat room</p>
            </div>

            <!-- Chat Room Container -->
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl border border-teal-200 overflow-hidden">
                <!-- Chat Status Bar -->
                <div class="bg-teal-50 border-b border-teal-200 px-6 py-4 flex items-center justify-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-teal-500 rounded-full animate-pulse shadow-sm"></div>
                        <span id="status-text" class="text-teal-700 text-sm font-semibold">Chat Room Active</span>
                        <div class="text-teal-600 text-xs bg-teal-100 px-2 py-1 rounded-full">Live</div>
                    </div>
                </div>

                <!-- RumbleTalk Chat Integration -->
                <div class="relative bg-teal-25">
                    <div style="height: 600px;" class="w-full">
                        <div id="chat-container" class="w-full h-full"></div>
                        <div id="loading-message" class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-teal-50 to-cyan-50">
                            <div class="text-center p-8 bg-white rounded-lg shadow-lg border border-teal-100">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-3 border-teal-600 mx-auto mb-6"></div>
                                <div class="text-teal-700 mb-3 font-semibold text-lg">Loading chat room...</div>
                                <div class="text-teal-500 text-sm">Please wait while we connect you to other students</div>
                                <div class="mt-4 flex items-center justify-center space-x-1">
                                    <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Info -->
            <div class="text-center mt-8">
                <div class="bg-white rounded-lg p-6 shadow-sm border border-teal-100">
                    <p class="text-teal-600 text-sm font-medium mb-2">ðŸ’¬ Join the conversation</p>
                    <p class="text-gray-500 text-xs">Connect with fellow students, share knowledge, and build your network</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 py-8 mt-16">
        <div class="max-w-6xl mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- VidyaGyan Info Column -->
                <div class="col-span-1 md:col-span-1">
                    <div class="flex items-center mb-4">
                        <img src="./assets/mainlogo.png" alt="VidyaGyan Logo" class="w-12 h-12 mr-3">
                        <h3 class="text-white font-bold text-xl">VidyaGyan</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Your all-in-one platform for academic and career guidance.</p>
                    
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z"/>
                            </svg>
                            <a href="mailto:team.blastorz@gmail.com" class="text-gray-400 hover:text-white text-sm transition-colors">
                                team.blastorz@gmail.com
                            </a>
                        </div>
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            <a href="members.html" class="text-gray-400 hover:text-white text-sm transition-colors">
                                Team Info
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Navigation Column -->
                <div class="col-span-1">
                    <h4 class="text-white font-semibold text-lg mb-3">Navigation</h4>
                    <ul class="space-y-2">
                        <li><a href="home.html" class="text-gray-400 hover:text-white text-sm transition-colors">Home</a></li>
                        <li><a href="profile.html" class="text-gray-400 hover:text-white text-sm transition-colors">Profile</a></li>
                        <li><a href="foryou.html" class="text-gray-400 hover:text-white text-sm transition-colors">For You</a></li>
                        <li><a href="career_paths.html" class="text-gray-400 hover:text-white text-sm transition-colors">Career Paths</a></li>
                    </ul>
                </div>

                <!-- Resources Column -->
                <div class="col-span-1">
                    <h4 class="text-white font-semibold text-lg mb-3">Resources</h4>
                    <ul class="space-y-2">
                        <li><a href="colleges.html" class="text-gray-400 hover:text-white text-sm transition-colors">Colleges</a></li>
                        <li><a href="roadmaps/roadmap.html" class="text-gray-400 hover:text-white text-sm transition-colors">Roadmaps</a></li>
                        <li><a href="exams.html" class="text-gray-400 hover:text-white text-sm transition-colors">Exams</a></li>
                        <li><a href="resources.html" class="text-gray-400 hover:text-white text-sm transition-colors">Study Materials</a></li>
                    </ul>
                </div>

                <!-- Community Column -->
                <div class="col-span-1">
                    <h4 class="text-white font-semibold text-lg mb-3">Community</h4>
                    <ul class="space-y-2">
                        <li><a href="study_groups.html" class="text-gray-400 hover:text-white text-sm transition-colors">Study Groups</a></li>
                        <li><a href="scholarship.html" class="text-gray-400 hover:text-white text-sm transition-colors">Scholarships</a></li>
                        <li><a href="login.html" class="text-gray-400 hover:text-white text-sm transition-colors">Login</a></li>
                        <li><a href="signup.html" class="text-gray-400 hover:text-white text-sm transition-colors">Sign Up</a></li>
                    </ul>
                </div>
            </div>

            <!-- Copyright -->
            <div class="border-t border-gray-700 mt-6 pt-4 text-center">
                <p class="text-gray-400 text-sm">
                    Copyright Â© 2025 - Team Blastorz ðŸ’¥
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Load chat room configuration
        async function loadChatRoom() {
            try {
                const groupId = getUrlParameter('id');
                const chatId = getUrlParameter('chatId');
                const scriptSrc = getUrlParameter('scriptSrc');

                if (!groupId || !chatId || !scriptSrc) {
                    throw new Error('Missing required parameters');
                }

                // Fetch group data to get name and description
                const response = await fetch('chat_rooms.json');
                const data = await response.json();
                const group = data.chatRooms.find(g => g.id === groupId);

                if (group) {
                    // Update page content with group info
                    document.getElementById('room-title').textContent = group.name;
                    document.getElementById('room-description').textContent = group.description;
                    document.getElementById('status-text').textContent = group.name + ' Active';
                    document.title = group.name + ' - VidyaGyan';
                } else {
                    // Fallback if group not found
                    document.getElementById('room-title').textContent = 'Study Group';
                    document.getElementById('room-description').textContent = 'Connect and chat with other students';
                }

                // Set up the chat container with the correct ID
                const chatContainer = document.getElementById('chat-container');
                chatContainer.id = chatId;

                // Load the RumbleTalk script
                const script = document.createElement('script');
                script.src = scriptSrc;
                script.onload = function() {
                    console.log('RumbleTalk script loaded successfully');
                    // Start auto-login attempts
                    startAutoLogin(chatId);
                };
                script.onerror = function() {
                    console.error('Failed to load RumbleTalk script');
                    showError('Failed to load chat. Please try again later.');
                };
                document.body.appendChild(script);

            } catch (error) {
                console.error('Failed to load chat room:', error);
                showError('Failed to load chat room. Please check the URL and try again.');
            }
        }

        function showError(message) {
            const loadingMsg = document.getElementById('loading-message');
            loadingMsg.innerHTML = `
                <div class="text-center p-8 bg-white rounded-lg shadow-lg border border-red-100">
                    <div class="text-red-700 mb-3 font-semibold text-lg">Error</div>
                    <div class="text-red-500 text-sm">${message}</div>
                    <button onclick="window.history.back()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Go Back
                    </button>
                </div>
            `;
        }

        // Auto-login function for RumbleTalk
        function startAutoLogin(chatId) {
            let attempts = 0;
            const maxAttempts = 15;
            
            const loginInterval = setInterval(() => {
                attempts++;
                console.log(`Auto-login attempt ${attempts} for ${chatId}`);
                
                const iframe = document.querySelector(`#${chatId} iframe`);
                if (iframe) {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        // Look for Guest button
                        const guestButton = iframeDoc.querySelector('button[data-testid="guest-login"]') || 
                                          iframeDoc.querySelector('.guest-login') ||
                                          iframeDoc.querySelector('button:contains("Guest")') ||
                                          iframeDoc.querySelector('[class*="guest"]') ||
                                          iframeDoc.querySelector('input[value="Guest"]');
                        
                        if (guestButton) {
                            console.log('Found guest button, clicking...');
                            guestButton.click();
                            
                            // After clicking guest, look for username input
                            setTimeout(() => {
                                const usernameInput = iframeDoc.querySelector('input[type="text"]') ||
                                                    iframeDoc.querySelector('input[placeholder*="name"]') ||
                                                    iframeDoc.querySelector('input[name="username"]') ||
                                                    iframeDoc.querySelector('#username');
                                
                                if (usernameInput) {
                                    console.log('Found username input, entering "student"...');
                                    usernameInput.value = 'student';
                                    usernameInput.dispatchEvent(new Event('input'));
                                    
                                    // Look for submit/join button
                                    const submitButton = iframeDoc.querySelector('button[type="submit"]') ||
                                                       iframeDoc.querySelector('.join-btn') ||
                                                       iframeDoc.querySelector('button:contains("Join")') ||
                                                       iframeDoc.querySelector('[class*="submit"]');
                                    
                                    if (submitButton) {
                                        console.log('Found submit button, clicking...');
                                        setTimeout(() => submitButton.click(), 500);
                                    }
                                }
                            }, 1000);
                        }
                    } catch (e) {
                        console.log('Cross-origin restriction - cannot access iframe content');
                    }
                }
                
                if (attempts >= maxAttempts) {
                    clearInterval(loginInterval);
                    console.log('Auto-login attempts completed');
                }
            }, 3000); // Try every 3 seconds
        }

        // Hide loading message after chat loads
        setTimeout(function() {
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) {
                loadingMsg.style.display = 'none';
            }
        }, 8000);

        // Mobile menu toggle
        document.getElementById('menu-btn').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // Initialize chat room when page loads
        window.addEventListener('DOMContentLoaded', loadChatRoom);
    </script>
</body>
</html>